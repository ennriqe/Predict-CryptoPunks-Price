# Predicting Crypto Punk Prices

In this project we have developed a model that predicts the prices of CryptoPunks, we do so by using 16k historical sales of these NFTs over the last 3 years by using as features their attributes, a time feature, the price of Etheurm, the floor price of the NFTs and features we extracted from their pixels. We end up with an accurate model that can predict the ETH prices of CryptoPunks with a **mean accuracy of 89%** as measured by 1-MAPE (Mean Absolute Percentage Error). 

This model has been trained so that it can generalize and produce a fair value for a given Punk in the future, it can potentially be used by people or smart contracts that want to assess how much a Punk is worth at a given time, based on this they could either, make a bid, accept one or set this price as an estimate of the TVL to issue a loan.

Given that the average price of these NFTs has been $100k over the last 3 years, market participants that might make use of these predictions will want to make sure that they are produced by the same unique model that has given the predictions for the other market participants, to ensure this, we use the **Giza ML** platform which allows us to train our model and produce **Zero-Knowledge proofs** that verify that a given prediction was generated by the model we offer.

# Forming the Dataset

To create the comprehensive dataset required for this project, follow the steps outlined below, utilizing various data sources ranging from Dune Analytics to external APIs.

## Crypto Punk Trades

To gather data on all Crypto Punk trades, utilize the following Dune Analytics query:
```sql
SELECT * FROM cryptopunks.trades
```

## Dune Query: [Cryptopunks Trades](https://dune.com/queries/3469248)

To download the data:
1. Access the link provided.
2. With Dune Plus, you can download the query results to a CSV file.

## Floor Price Data: [Floor Price Data](https://dune.com/queries/3455015)

The floor price data is sourced through a Dune Analytics query, structured as follows:

```sql
-- Dune Query for Floor Price Data
WITH
  time_series AS (
    SELECT
      day
    FROM
      UNNEST (
        SEQUENCE(
          TRY_CAST('2017-01-01' AS TIMESTAMP),
          CAST(
            CAST(
              CAST(DATE_TRUNC('day', CURRENT_TIMESTAMP) AS TIMESTAMP) AS TIMESTAMP
            ) AS TIMESTAMP
          ),
          INTERVAL '1' day
        )
      ) AS _u (day)
  ),
  cryptopunk_sales AS (
    SELECT
      DATE_TRUNC('day', evt_block_time) AS day,
      APPROX_PERCENTILE(value / CAST(1e18 AS DOUBLE), 0.1) AS crypto_punk_median
    FROM
      cryptopunks_ethereum.CryptoPunksMarket_evt_PunkBought
    WHERE
      NOT evt_tx_hash IN (
        0x92488a00dfa0746c300c66a716e6cc11ba9c0f9d40d8c58e792cc7fcebf432d0,
        0xc6820189dcc84bcd41ee012549284a6727d76cb2d2cc0db376ca2f928556ab0f
      )
      AND value > 0
    GROUP BY
      1
  ),
  bayc_sales AS (
    SELECT
      DATE_TRUNC('day', block_time) AS day,
      APPROX_PERCENTILE(amount_original, 0.1) AS bayc_median
    FROM
      nft.trades
    WHERE
      blockchain = 'ethereum'
      AND nft_contract_address = 0xbc4ca0eda7647a8ab7c2061c2e118a18a936f13d
      AND NOT token_id IS NULL
      AND currency_symbol IN ('ETH', 'WETH')
    GROUP BY
      1
  )
SELECT
  ts.day,
  AVG(crypto_punk_median) OVER (
    ORDER BY
      ts.day ROWS BETWEEN TRY_CAST('{{Moving Average}}' AS INTEGER) PRECEDING
      AND CURRENT ROW
  ) AS "CP Price",
  AVG(bayc_median) OVER (
    ORDER BY
      ts.day ROWS BETWEEN TRY_CAST('{{Moving Average}}' AS INTEGER) PRECEDING
      AND CURRENT ROW
  ) AS "BAYC Price"
FROM
  time_series AS ts
  LEFT JOIN cryptopunk_sales AS cs ON ts.day = cs.day
  LEFT JOIN bayc_sales AS bs ON ts.day = bs.day
```
# Others
To query the images of the punks that we use to extract the skin color of the punks we use and run label_skin.py and get the data from https://huggingface.co/datasets/huggingnft/cryptopunks

To query the floor price today we use the OpenSea API using get_punk_floor_today().

To query the ETH price we query the CoinGecko API using get_ethereum_price_history().

To generate the whole dataset we use generate_dataset.py

#Process and Label Data
## Step 1: Process and Label Data

- **Run `label_skin.py`:** Execute this script to process the downloaded punk images and label them based on skin color. This step is crucial for incorporating visual traits into the dataset.

## Step 2: Generate the Dataset

- **Execute `generate_dataset.py`:** This script integrates the trade data, floor prices, skin color information, current floor price, and Ethereum price history into a comprehensive dataset. Make sure all prerequisite data from Step 1 is ready before running this script.

## Step 3: Train and perform predictions

- **Execute the Notebook:** Once the dataset is prepared, run the provided `giza_build.ipynb` to analyze the data. The notebook includes the steps listed [here](https://actions.gizatech.xyz/tutorials/build-a-verifiable-neural-network-with-giza-actions) with the giza-actions


## Alternative Model outside of Giza

- We also include the notebook Predict **CryptoPunks Prices LightGBM.ipynb** that trains a LightGBM model, a boosting gradient model, this model ended up not being compatible with Giza's platform, but it achieved good results and is more interpretabla than the Naural Network. This notebook plots the price of ETH, mean, and Floor price of the Punks, it plots the training of the model and the errors. It shows the top 20 features by feature importance and uses Shap to explain AI estimation and how each feature affects the output.
![image](https://github.com/ennriqe/Predict-CryptoPunks-Price/assets/36388434/27074872-37a9-4573-b60a-b5d2b4949bf6)

![image](https://github.com/ennriqe/Predict-CryptoPunks-Price/assets/36388434/8066cbea-3807-41c3-9fe6-52a914503c19)


## Errors when trying to use GizaModel with verifiable=True

- Unfortunately we were not able to submit a version that run the proof that the output of the model was produced by our model using Giza's framework, we kept getting some small errors that we could not solve. 
<p align="center">
  <img src="https://github.com/ennriqe/Predict-CryptoPunks-Price/assets/36388434/e60fd882-8d17-4d42-ae29-1934c0343de8" alt="Your Image Description">
</p>

---

### Prerequisites
Ensure you have installed all required libraries and have API access set up for OpenSea. Follow the installation instructions and API documentation for each service to get started.

